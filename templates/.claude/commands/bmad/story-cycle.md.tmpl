---
description: BMAD story development cycle for {{PROJECT_NAME}} ({{PROJECT_TYPE}}) - Complete story implementation with Docker container management.
allowed-tools: Bash(git:*), Bash(node:*), Bash(npm:*), Bash({{TASKMASTER_CLI}}:*), Bash(npx task-master:*), Bash(pytest:*), Bash(docker:*), Bash(docker-compose:*), mcp__docker__list_containers, mcp__docker__get_container_logs, mcp__docker__execute_command
---

# /bmad:story-cycle

## DOCKER-BASED STORY DEVELOPMENT WORKFLOW

Complete story implementation from task assignment to deployment, with all development happening in Docker containers.

## 0) MANDATORY: EXECUTION AUTHORIZATION VALIDATION

**COMPLIANCE ENFORCEMENT: Validate execution authority before proceeding**
```bash
# CRITICAL: Validate this workflow has execution authorization
TASK_ID=${1:-$({{TASKMASTER_CLI}} current-task-id 2>/dev/null)}
EXECUTION_AUTHORIZED=${2:-false}

if [ "$EXECUTION_AUTHORIZED" != "true" ]; then
    echo "‚ùå COMPLIANCE VIOLATION: Story cycle requires execution authorization"
    echo "Required: Must be routed from orchestrator with --execution-authorized=true"
    echo ""
    echo "Proper usage: /bmad:story-cycle --task-id=<id> --execution-authorized=true"
    echo ""
    echo "If this is a direct story request (not from planning):"
    echo "1. Create task: {{TASKMASTER_CLI}} create --title='Story: [description]'"
    echo "2. Route through orchestrator for authorization"
    exit 1
fi

# Validate task exists and is properly tracked
if [ -z "$TASK_ID" ]; then
    echo "‚ùå COMPLIANCE VIOLATION: Task ID required for story workflow"
    echo "Required: All story work must be tracked in Task Master"
    exit 1
fi

# Verify task status allows execution
TASK_STATUS=$({{TASKMASTER_CLI}} get-status --id=$TASK_ID 2>/dev/null)
if [[ "$TASK_STATUS" != "execution-authorized" && "$TASK_STATUS" != "in-progress" ]]; then
    echo "‚ùå COMPLIANCE VIOLATION: Task $TASK_ID not authorized for execution"
    echo "Current status: $TASK_STATUS"
    echo "Required status: execution-authorized or in-progress"
    exit 1
fi

# Set task status to in-progress
{{TASKMASTER_CLI}} set-status --id=$TASK_ID --status=in-progress

echo "‚úÖ Execution authorization validated for story cycle"
echo "üìã Task ID: $TASK_ID"
echo "üîß Story workflow authorized to proceed"
```

**Task Master Integration (MANDATORY):**
```bash
# Initialize or update task tracking
if [ -n "$TASK_ID" ]; then
    # Update existing task
    {{TASKMASTER_CLI}} update-task --id=$TASK_ID --prompt="Story cycle started - execution authorized"
else
    # Create new story task if none provided
    TASK_ID=$({{TASKMASTER_CLI}} create --title="Story: [Auto-generated]" --type="story" --status="in-progress")
    echo "üìù Created story task: $TASK_ID"
fi

# Set story-specific metadata
{{TASKMASTER_CLI}} set-field --id=$TASK_ID --field="workflow" --value="story-cycle"
{{TASKMASTER_CLI}} set-field --id=$TASK_ID --field="execution-start" --value="$(date -Iseconds)"
```

## PHASE 0: INFRASTRUCTURE SETUP

### 0A) Task Master Integration
```bash
# Get next task or specific task
STORY_ID=$({{TASKMASTER_CLI}} next --field=id)
STORY_TITLE=$({{TASKMASTER_CLI}} next --field=title)
echo "üìã Working on: $STORY_TITLE (ID: $STORY_ID)"

# Set task to in-progress
{{TASKMASTER_CLI}} set-status --id=$STORY_ID --status=in-progress
```

### 0B) Docker Environment Setup
```bash
# Ensure Docker is running
docker info > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "‚ùå Docker not running. Starting Docker Desktop..."
    ./.claude/hooks/docker-manager.sh start
fi

# Start development containers
docker-compose up -d --build
echo "‚è≥ Waiting for services to be healthy..."
sleep 5

# Verify health
./.claude/hooks/docker-manager.sh health
```

## PHASE 1: STORY CREATION & REFINEMENT

### 1A) Scrum Master ‚Üí Story Creation
**Load Scrum Master Agent:**
```
Load the sm-agent to create or refine the user story.
Story must reference Task Master ID: $STORY_ID
```

**Story Creation Process:**
1. Understand requirements from task description
2. Create comprehensive user story with acceptance criteria
3. Define Docker-based implementation approach
4. Identify container-specific dependencies
5. Update task with story location

**Quality Gate - Story Validation:**
```bash
# Automated validation hook with scoring
./.claude/hooks/validation-enforcer.sh -EventType "pre-story-development" -Context @{StoryId=$STORY_ID}

# Hook will:
# - Check for existing story validation report
# - Run automated validation if no report exists
# - Enforce minimum score of 7/10
# - Block workflow if validation fails
echo "‚úÖ Story validation passed - proceeding to development"
```

## PHASE 2: PRODUCT OWNER VALIDATION

### 2A) Product Owner ‚Üí Story Approval
**Load Product Owner Agent:**
```
Load the po-agent to validate story completeness and alignment.
```

**Product Owner Validation Process:**
```bash
# Automated PO validation with comprehensive scoring
./.claude/hooks/validation-enforcer.sh -EventType "pre-story-development" -Context @{StoryId=$STORY_ID} -DocumentPath "docs/stories/story-$STORY_ID.md"

# Validation includes:
# - Docker environment requirements specified
# - Container health checks defined  
# - Test approach includes container testing
# - Deployment strategy considers containerization
# - Acceptance criteria completeness (automated scoring)
# - Technical feasibility assessment
echo "‚úÖ Product Owner validation completed"
```

## PHASE 3: DEVELOPMENT IN CONTAINERS

### 3A) Developer ‚Üí Implementation
**Load Developer Agent:**
```
Load the dev-agent for Docker-based implementation.
```

**CRITICAL DEVELOPMENT REMINDER:**
```
‚ö†Ô∏è NO DUMMY DATA OR FALLBACK IMPLEMENTATIONS ALLOWED!
- All features must use REAL data connections
- Failures must be VISIBLE, not hidden
- No catch blocks returning fake success
- No hardcoded test data in production code
```

**Docker Development Process:**
```bash
# All development happens in containers
echo "üê≥ Starting Docker-based development..."

# Install dependencies in container
docker-compose exec backend npm install [required-packages]
docker-compose exec frontend npm install [required-packages]

# Run development servers
docker-compose up -d

# Watch logs during development
docker-compose logs -f &
```

**Implementation Steps:**
1. **Code Development**:
   ```bash
   # Edit files on host, hot-reload in containers
   # Volumes mount source code into containers
   ```

2. **Run Tests in Containers**:
   ```bash
   docker-compose exec backend npm test
   docker-compose exec frontend npm test
   ```

3. **Database Operations**:
   ```bash
   docker-compose exec backend npm run migrate
   docker-compose exec db psql -U postgres
   ```

4. **Debug in Containers**:
   ```bash
   docker-compose exec backend /bin/bash
   docker-compose logs backend --tail=100
   ```

**Quality Gate - Implementation Validation:**
```bash
# Check for dummy data patterns FIRST
echo "üîç Running no-dummy-data quality gate..."
./.claude/hooks/quality-gate-no-dummies.sh
if [ $? -ne 0 ]; then
    echo "‚ùå Dummy data or fallback patterns detected!"
    echo "Fix all issues before proceeding"
    exit 1
fi

# Before marking development complete
docker-compose exec backend npm test
docker-compose exec backend npm run lint
docker-compose ps  # All containers healthy
```

## PHASE 4: QUALITY ASSURANCE IN DOCKER

### 4A) QA Engineer ‚Üí Docker-Based Testing
**Load QA Engineer Agent:**
```
Load the qa-agent for containerized quality assurance.
```

**Docker QA Process:**
```bash
# FIRST: Validate no dummy data patterns
echo "üîç QA: Checking for dummy data and fallback patterns..."
./.claude/hooks/quality-gate-no-dummies.sh
if [ $? -ne 0 ]; then
    echo "‚ùå QA FAILED: Dummy data or fallback implementations found!"
    echo "Returning to developer for fixes"
    exit 1
fi

# Run comprehensive tests in containers
docker-compose exec backend npm run test:unit
docker-compose exec backend npm run test:integration
docker-compose exec frontend npm run test:e2e

# Check container health
mcp__docker__list_containers
mcp__docker__get_container_stats --container_id={{PROJECT_NAME}}_backend_1

# Review logs for errors
docker-compose logs --since 1h | grep -i error
```

**Performance Testing:**
```bash
# Load testing in containers
docker-compose exec backend npm run test:load

# Monitor resource usage
docker stats --no-stream
```

**Quality Gate - Definition of Done:**
```bash
# Automated DoD validation before story completion
./.claude/hooks/validation-enforcer.sh -EventType "pre-story-completion" -Context @{StoryId=$STORY_ID}

# Validation enforces:
# - All tests pass (minimum score 9/10)
# - No dummy data patterns detected
# - Docker health checks pass
# - Documentation updated
# - Acceptance criteria fully met
echo "‚úÖ Definition of Done validation passed"
```

**QA Decision:**
- **APPROVED**: All tests pass AND no dummy data patterns found AND DoD score ‚â•9/10
- **NEEDS_WORK**: Issues found, return to dev
- **AUTOMATIC REJECTION**: Any dummy data, mock implementations, or silent failures

## PHASE 5: DOCUMENTATION & LEARNINGS

### 5A) Documentation Agent ‚Üí Update Docs
**Load Documentation Agent:**
```
Load the doc-agent to update project documentation.
```

**Documentation Updates:**
- Update README with Docker setup instructions
- Document container architecture changes
- Update API documentation
- Add Docker troubleshooting guides

### 5B) Learnings Agent ‚Üí Capture Insights
**Load Learnings Agent:**
```
Load the learnings-agent to extract lessons learned.
```

**Capture Docker-specific learnings:**
- Container optimization techniques discovered
- Performance improvements found
- Docker troubleshooting solutions

## PHASE 6: GIT INTEGRATION & BACKUP

### 6A) Git Agent ‚Üí Commit and Push
**Load Git Agent:**
```
Load the git-agent for version control with Task Master integration.
```

**Git Process with Docker:**
```bash
# Stage changes
git add -A

# Commit with task reference
git commit -m "feat: $STORY_TITLE [task: $STORY_ID]"

# Get commit SHA
COMMIT_SHA=$(git rev-parse HEAD)

# Push to GitHub
git push origin main

# Update task with commit
{{TASKMASTER_CLI}} update-task --id=$STORY_ID --prompt="commit: $COMMIT_SHA"
```

## PHASE 7: DOCKER DEPLOYMENT PREPARATION

### 7A) Build Production Images
```bash
# Build production images
docker-compose -f docker-compose.prod.yml build

# Run production tests
docker-compose -f docker-compose.prod.yml up -d
docker-compose -f docker-compose.prod.yml exec backend npm test

# Tag images for deployment
docker tag {{PROJECT_NAME}}_backend:latest {{PROJECT_NAME}}_backend:$STORY_ID
docker tag {{PROJECT_NAME}}_frontend:latest {{PROJECT_NAME}}_frontend:$STORY_ID
```

### 7B) Container Health Verification
```bash
# Final health check
./.claude/hooks/docker-manager.sh health

# Verify all services responding
curl http://localhost:{{FRONTEND_PORT}}
curl http://localhost:{{BACKEND_PORT}}/health
```

## PHASE 8: DOCUMENTATION & COMPLETION

### 8A) Automatic Documentation Updates
**Load Documentation Agent:**
```
Load the doc-agent to update all project documentation.
```

**Documentation Process:**
1. **Update CHANGELOG.md** with task completion
2. **Create story documentation** in docs/story-notes/
3. **Update README.md** if features added
4. **Update API docs** if endpoints changed
5. **Run documentation hook** for automation

**Automated Documentation Update:**
```bash
# Run documentation updater hook
./.claude/hooks/documentation-updater.sh -Action update \
    -TaskId "$STORY_ID" \
    -TaskTitle "$STORY_TITLE" \
    -ChangeType "feature"

echo "üìö Documentation updated automatically"
```

### 8B) Mark Task Complete
```bash
# Update task status
{{TASKMASTER_CLI}} set-status --id=$STORY_ID --status=done
{{TASKMASTER_CLI}} update-task --id=$STORY_ID --prompt="Story complete. Commit: $COMMIT_SHA. Docs updated."

# Clean up Docker resources
docker-compose down

echo "‚úÖ Story $STORY_ID complete with documentation!"
```

### 8C) Get Next Task
```bash
# Check for next task
NEXT_TASK=$({{TASKMASTER_CLI}} next)
if [ ! -z "$NEXT_TASK" ]; then
    echo "üìã Next task available. Run: /bmad:story-cycle"
else
    echo "üéâ No more tasks! All caught up."
fi
```

## DOCKER TROUBLESHOOTING

### Common Issues During Development

**Container Won't Start:**
```bash
docker-compose logs [service]
docker-compose down -v
docker-compose up -d --build
```

**Tests Fail in Container:**
```bash
# Debug in container
docker-compose exec backend /bin/bash
npm test -- --verbose

# Check environment
docker-compose exec backend env
```

**Port Conflicts:**
```bash
# Find conflicting process
lsof -i :{{FRONTEND_PORT}}
lsof -i :{{BACKEND_PORT}}

# Change ports in docker-compose.yml
```

**Performance Issues:**
```bash
# Check resource usage
docker stats
docker system df

# Clean up
docker system prune -a
```

## SUCCESS CRITERIA

**Story is complete when:**
- [ ] All acceptance criteria met
- [ ] Tests pass in Docker containers
- [ ] Container health checks pass
- [ ] Documentation updated
- [ ] Code committed with task reference
- [ ] Task marked done in Task Master
- [ ] GitHub backup complete
- [ ] Production images built and tested

## WORKFLOW COMMANDS

### Quick Commands
- `docker-compose up -d` - Start development
- `docker-compose logs -f` - Watch logs
- `docker-compose exec [service] [command]` - Run in container
- `docker-compose down` - Stop everything
- `./.claude/hooks/docker-manager.sh health` - Check health
- `./.claude/hooks/docker-manager.sh troubleshoot` - Debug issues

Remember: All development, testing, and validation happens inside Docker containers. Never install dependencies on the host machine.