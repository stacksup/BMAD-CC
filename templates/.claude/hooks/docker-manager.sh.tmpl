#!/usr/bin/env bash
# Docker Container Management for BMAD Projects
# Assumes all projects run in Docker containers

set -e

# Default parameters
ACTION="${1:-status}"
SERVICE="${2:-all}"
FORCE="${3:-false}"

# Configuration
PROJECT_NAME="{{PROJECT_NAME}}"
PROJECT_TYPE="{{PROJECT_TYPE}}"
DOCKER_COMPOSE_FILE="${DOCKER_COMPOSE_FILE:-{{DOCKER_COMPOSE_FILE}}}"
FRONTEND_PORT="${FRONTEND_PORT:-{{FRONTEND_PORT}}}"
BACKEND_PORT="${BACKEND_PORT:-{{BACKEND_PORT}}}"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
NC='\033[0m'

# Docker compose file detection
get_docker_compose_file() {
    if [ -n "$DOCKER_COMPOSE_FILE" ] && [ -f "$DOCKER_COMPOSE_FILE" ]; then
        echo "$DOCKER_COMPOSE_FILE"
        return 0
    fi
    
    # Check common locations
    local possible_files=(
        "docker-compose.yml"
        "docker-compose.yaml"
        "compose.yml"
        "compose.yaml"
        "docker-compose.dev.yml"
        "docker-compose.local.yml"
    )
    
    for file in "${possible_files[@]}"; do
        if [ -f "$file" ]; then
            echo "$file"
            return 0
        fi
    done
    
    return 1
}

# Check Docker installation
test_docker_available() {
    if command -v docker &> /dev/null && docker --version &> /dev/null; then
        return 0
    fi
    return 1
}

# Check Docker Compose installation
test_docker_compose_available() {
    # Try docker compose (v2)
    if docker compose version &> /dev/null 2>&1; then
        echo "docker compose"
        return 0
    fi
    
    # Try docker-compose (v1)
    if command -v docker-compose &> /dev/null && docker-compose --version &> /dev/null 2>&1; then
        echo "docker-compose"
        return 0
    fi
    
    return 1
}

# Get container status
get_container_status() {
    local service_name="$1"
    local compose_file
    local compose_cmd
    
    if ! compose_file=$(get_docker_compose_file); then
        echo '{"status": "no-compose", "message": "No docker-compose file found"}'
        return 1
    fi
    
    if ! compose_cmd=$(test_docker_compose_available); then
        echo '{"status": "no-compose-cli", "message": "Docker Compose not installed"}'
        return 1
    fi
    
    # Check if containers are running
    local ps_output
    if [ -n "$service_name" ] && [ "$service_name" != "all" ]; then
        ps_output=$($compose_cmd -f "$compose_file" ps "$service_name" 2>/dev/null || true)
    else
        ps_output=$($compose_cmd -f "$compose_file" ps 2>/dev/null || true)
    fi
    
    if [ -n "$ps_output" ] && echo "$ps_output" | grep -q "Up\|running"; then
        echo '{"status": "running"}'
        return 0
    else
        echo '{"status": "stopped", "message": "Containers not running"}'
        return 1
    fi
}

# Start Docker containers
start_docker_containers() {
    local service_name="$1"
    
    echo -e "${CYAN}ðŸ³ Starting Docker containers...${NC}"
    
    local compose_file
    if ! compose_file=$(get_docker_compose_file); then
        echo -e "${RED}No docker-compose file found${NC}" >&2
        return 1
    fi
    
    local compose_cmd
    if ! compose_cmd=$(test_docker_compose_available); then
        echo -e "${RED}Docker Compose not installed${NC}" >&2
        return 1
    fi
    
    # Build images if needed
    echo -e "${GRAY}Building Docker images...${NC}"
    if [ -n "$service_name" ] && [ "$service_name" != "all" ]; then
        $compose_cmd -f "$compose_file" build "$service_name"
    else
        $compose_cmd -f "$compose_file" build
    fi
    
    # Start containers
    echo -e "${GRAY}Starting containers...${NC}"
    if [ -n "$service_name" ] && [ "$service_name" != "all" ]; then
        $compose_cmd -f "$compose_file" up -d "$service_name"
    else
        $compose_cmd -f "$compose_file" up -d
    fi
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… Docker containers started successfully${NC}"
        
        # Wait for services to be healthy
        sleep 3
        test_service_health
        
        return 0
    fi
    
    return 1
}

# Stop Docker containers
stop_docker_containers() {
    local service_name="$1"
    
    echo -e "${CYAN}ðŸ›‘ Stopping Docker containers...${NC}"
    
    local compose_file
    if ! compose_file=$(get_docker_compose_file); then
        return 0  # Nothing to stop
    fi
    
    local compose_cmd
    if ! compose_cmd=$(test_docker_compose_available); then
        return 0  # Can't stop without compose
    fi
    
    if [ -n "$service_name" ] && [ "$service_name" != "all" ]; then
        $compose_cmd -f "$compose_file" stop "$service_name"
    else
        $compose_cmd -f "$compose_file" stop
    fi
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… Docker containers stopped${NC}"
        return 0
    fi
    
    return 1
}

# Restart Docker containers
restart_docker_containers() {
    local service_name="$1"
    
    echo -e "${CYAN}ðŸ”„ Restarting Docker containers...${NC}"
    
    stop_docker_containers "$service_name"
    sleep 2
    start_docker_containers "$service_name"
}

# Test service health
test_service_health() {
    echo -e "${CYAN}ðŸ©º Checking service health...${NC}"
    
    local healthy=0
    
    # Check frontend health
    if [ -n "$FRONTEND_PORT" ] && [ "$FRONTEND_PORT" != "0" ]; then
        if curl -s -o /dev/null -w "%{http_code}" "http://localhost:$FRONTEND_PORT" | grep -q "200\|301\|302"; then
            echo -e "${GREEN}âœ… Frontend healthy on port $FRONTEND_PORT${NC}"
        else
            echo -e "${YELLOW}âš ï¸ Frontend not responding on port $FRONTEND_PORT${NC}"
            healthy=1
        fi
    fi
    
    # Check backend health
    if [ -n "$BACKEND_PORT" ] && [ "$BACKEND_PORT" != "0" ]; then
        local health_endpoints=("/health" "/api/health" "/" "/api")
        local backend_healthy=false
        
        for endpoint in "${health_endpoints[@]}"; do
            if curl -s -o /dev/null -w "%{http_code}" "http://localhost:$BACKEND_PORT$endpoint" | grep -q "200\|204"; then
                echo -e "${GREEN}âœ… Backend healthy on port $BACKEND_PORT${NC}"
                backend_healthy=true
                break
            fi
        done
        
        if [ "$backend_healthy" = false ]; then
            echo -e "${YELLOW}âš ï¸ Backend not responding on port $BACKEND_PORT${NC}"
            healthy=1
        fi
    fi
    
    return $healthy
}

# Main execution
case "$ACTION" in
    start)
        start_docker_containers "$SERVICE"
        ;;
    
    stop)
        stop_docker_containers "$SERVICE"
        ;;
    
    restart)
        restart_docker_containers "$SERVICE"
        ;;
    
    status)
        echo -e "\n${CYAN}ðŸ³ Docker Status for $PROJECT_NAME${NC}"
        echo "=================================================="
        
        if ! test_docker_available; then
            echo -e "${RED}âŒ Docker not available${NC}"
            echo -e "${YELLOW}Please install Docker Desktop${NC}"
            exit 1
        fi
        
        status=$(get_container_status)
        if echo "$status" | grep -q '"status": "running"'; then
            echo -e "${GREEN}âœ… Containers running${NC}"
            docker ps --format "  - {{.Names}}: {{.State}}"
        else
            message=$(echo "$status" | grep -o '"message": "[^"]*"' | sed 's/"message": "\(.*\)"/\1/')
            echo -e "${YELLOW}âš ï¸ Containers not running: $message${NC}"
            echo -e "${CYAN}Start with: /bmad:docker start${NC}"
        fi
        
        echo "=================================================="
        ;;
    
    health)
        test_service_health
        ;;
    
    *)
        echo -e "${RED}Unknown action: $ACTION${NC}" >&2
        echo "Valid actions: start, stop, restart, status, health"
        exit 1
        ;;
esac